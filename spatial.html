<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Spatial Analysis in R | DfT R Cookbook</title>
  <meta name="description" content="Guidance and code examples for R usage for DfT and beyond" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Spatial Analysis in R | DfT R Cookbook" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Guidance and code examples for R usage for DfT and beyond" />
  <meta name="github-repo" content="departmentfortransport/R-cookbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Spatial Analysis in R | DfT R Cookbook" />
  
  <meta name="twitter:description" content="Guidance and code examples for R usage for DfT and beyond" />
  

<meta name="author" content="Isi Avbulimen, Hannah Bougdah, Tamsin Forbes, Jack Marks, Tim Taylor" />


<meta name="date" content="2020-05-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="RAP.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.13/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="index.html#section"></a></li>
<li class="chapter" data-level="1" data-path="why-do-we-need-another-book.html"><a href="why-do-we-need-another-book.html"><i class="fa fa-check"></i><b>1</b> Why do we need <em>another</em> book?</a><ul>
<li class="chapter" data-level="1.1" data-path="why-do-we-need-another-book.html"><a href="why-do-we-need-another-book.html#coding-standards"><i class="fa fa-check"></i><b>1.1</b> Coding standards</a></li>
<li class="chapter" data-level="1.2" data-path="why-do-we-need-another-book.html"><a href="why-do-we-need-another-book.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
<li class="chapter" data-level="1.3" data-path="why-do-we-need-another-book.html"><a href="why-do-we-need-another-book.html#work-in-progress"><i class="fa fa-check"></i><b>1.3</b> Work in progress</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> The basics</a><ul>
<li class="chapter" data-level="2.1" data-path="basics.html"><a href="basics.html#r-family"><i class="fa fa-check"></i><b>2.1</b> R family</a></li>
<li class="chapter" data-level="2.2" data-path="basics.html"><a href="basics.html#dft-rrstudio---subject-to-change"><i class="fa fa-check"></i><b>2.2</b> DfT R/RStudio - subject to change</a></li>
<li class="chapter" data-level="2.3" data-path="basics.html"><a href="basics.html#rstudio-ide"><i class="fa fa-check"></i><b>2.3</b> RStudio IDE</a><ul>
<li class="chapter" data-level="2.3.1" data-path="basics.html"><a href="basics.html#left-bottom-left-if-you-have-scripts-open"><i class="fa fa-check"></i><b>2.3.1</b> Left (bottom left if you have scripts open)</a></li>
<li class="chapter" data-level="2.3.2" data-path="basics.html"><a href="basics.html#top-right-environment-and-other-tabs"><i class="fa fa-check"></i><b>2.3.2</b> Top right; <strong>Environment</strong>, and other tabs</a></li>
<li class="chapter" data-level="2.3.3" data-path="basics.html"><a href="basics.html#bottom-right"><i class="fa fa-check"></i><b>2.3.3</b> Bottom right</a></li>
<li class="chapter" data-level="2.3.4" data-path="basics.html"><a href="basics.html#other-handy-buttons-in-rstudio-ide"><i class="fa fa-check"></i><b>2.3.4</b> Other handy buttons in RStudio IDE</a></li>
<li class="chapter" data-level="2.3.5" data-path="basics.html"><a href="basics.html#rstudio-menu-bar-a-few-pointers"><i class="fa fa-check"></i><b>2.3.5</b> RStudio menu bar a few pointers</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="basics.html"><a href="basics.html#projects"><i class="fa fa-check"></i><b>2.4</b> Projects</a><ul>
<li class="chapter" data-level="2.4.1" data-path="basics.html"><a href="basics.html#folders"><i class="fa fa-check"></i><b>2.4.1</b> Folders</a></li>
<li class="chapter" data-level="2.4.2" data-path="basics.html"><a href="basics.html#sessioninfo"><i class="fa fa-check"></i><b>2.4.2</b> sessionInfo()</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="basics.html"><a href="basics.html#r-memory"><i class="fa fa-check"></i><b>2.5</b> R memory</a></li>
<li class="chapter" data-level="2.6" data-path="basics.html"><a href="basics.html#a-note-on-rounding"><i class="fa fa-check"></i><b>2.6</b> A note on rounding</a></li>
<li class="chapter" data-level="2.7" data-path="basics.html"><a href="basics.html#assignment-operators---vs"><i class="fa fa-check"></i><b>2.7</b> Assignment operators <code>&lt;-</code> vs <code>=</code></a></li>
<li class="chapter" data-level="2.8" data-path="basics.html"><a href="basics.html#arithmetic-operators"><i class="fa fa-check"></i><b>2.8</b> Arithmetic operators</a></li>
<li class="chapter" data-level="2.9" data-path="basics.html"><a href="basics.html#relational-operators"><i class="fa fa-check"></i><b>2.9</b> Relational operators</a></li>
<li class="chapter" data-level="2.10" data-path="basics.html"><a href="basics.html#logical-operators"><i class="fa fa-check"></i><b>2.10</b> Logical operators</a></li>
<li class="chapter" data-level="2.11" data-path="basics.html"><a href="basics.html#vectors"><i class="fa fa-check"></i><b>2.11</b> Vectors</a><ul>
<li class="chapter" data-level="2.11.1" data-path="basics.html"><a href="basics.html#vector-types"><i class="fa fa-check"></i><b>2.11.1</b> Types</a></li>
<li class="chapter" data-level="2.11.2" data-path="basics.html"><a href="basics.html#conversion-between-atomic-vector-types"><i class="fa fa-check"></i><b>2.11.2</b> Conversion between atomic vector types</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-import.html"><a href="data-import.html"><i class="fa fa-check"></i><b>3</b> Data Importing/Exporting and interaction with other programmes</a><ul>
<li class="chapter" data-level="3.1" data-path="data-import.html"><a href="data-import.html#libraries"><i class="fa fa-check"></i><b>3.1</b> Libraries</a></li>
<li class="chapter" data-level="3.2" data-path="data-import.html"><a href="data-import.html#star-functions"><i class="fa fa-check"></i><b>3.2</b> Star functions</a></li>
<li class="chapter" data-level="3.3" data-path="data-import.html"><a href="data-import.html#navigating-folders"><i class="fa fa-check"></i><b>3.3</b> Navigating folders</a><ul>
<li class="chapter" data-level="3.3.1" data-path="data-import.html"><a href="data-import.html#up"><i class="fa fa-check"></i><b>3.3.1</b> Up</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="data-import.html"><a href="data-import.html#rds"><i class="fa fa-check"></i><b>3.4</b> .rds</a></li>
<li class="chapter" data-level="3.5" data-path="data-import.html"><a href="data-import.html#csv"><i class="fa fa-check"></i><b>3.5</b> .csv</a></li>
<li class="chapter" data-level="3.6" data-path="data-import.html"><a href="data-import.html#xlsx-and-.xls"><i class="fa fa-check"></i><b>3.6</b> .xlsx and .xls</a><ul>
<li class="chapter" data-level="3.6.1" data-path="data-import.html"><a href="data-import.html#single-worksheet---single-workbook"><i class="fa fa-check"></i><b>3.6.1</b> Single worksheet - single workbook</a></li>
<li class="chapter" data-level="3.6.2" data-path="data-import.html"><a href="data-import.html#single-worksheet---many-workbooks"><i class="fa fa-check"></i><b>3.6.2</b> Single worksheet - many workbooks</a></li>
<li class="chapter" data-level="3.6.3" data-path="data-import.html"><a href="data-import.html#many-worksheets---single-workbook"><i class="fa fa-check"></i><b>3.6.3</b> Many worksheets - single workbook</a></li>
<li class="chapter" data-level="3.6.4" data-path="data-import.html"><a href="data-import.html#many-worksheets---many-workbooks"><i class="fa fa-check"></i><b>3.6.4</b> Many worksheets - many workbooks</a></li>
<li class="chapter" data-level="3.6.5" data-path="data-import.html"><a href="data-import.html#non-rectangular-data---single-worksheet---single-workbook"><i class="fa fa-check"></i><b>3.6.5</b> Non-rectangular data - single worksheet - single workbook</a></li>
<li class="chapter" data-level="3.6.6" data-path="data-import.html"><a href="data-import.html#non-rectangular-data---single-worksheet---many-workbooks"><i class="fa fa-check"></i><b>3.6.6</b> Non-rectangular data - single worksheet - many workbooks</a></li>
<li class="chapter" data-level="3.6.7" data-path="data-import.html"><a href="data-import.html#non-rectangular-data---many-worksheets---single-workbook"><i class="fa fa-check"></i><b>3.6.7</b> Non-rectangular data - many worksheets - single workbook</a></li>
<li class="chapter" data-level="3.6.8" data-path="data-import.html"><a href="data-import.html#non-rectangular-data---many-worksheets---many-workbooks"><i class="fa fa-check"></i><b>3.6.8</b> Non-rectangular data - many worksheets - many workbooks</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="data-import.html"><a href="data-import.html#exporting-to-.xlsx"><i class="fa fa-check"></i><b>3.7</b> Exporting to .xlsx</a></li>
<li class="chapter" data-level="3.8" data-path="data-import.html"><a href="data-import.html#sav"><i class="fa fa-check"></i><b>3.8</b> .sav</a></li>
<li class="chapter" data-level="3.9" data-path="data-import.html"><a href="data-import.html#sql"><i class="fa fa-check"></i><b>3.9</b> SQL</a></li>
<li class="chapter" data-level="3.10" data-path="data-import.html"><a href="data-import.html#gcp"><i class="fa fa-check"></i><b>3.10</b> GCP</a><ul>
<li class="chapter" data-level="3.10.1" data-path="data-import.html"><a href="data-import.html#bigquery"><i class="fa fa-check"></i><b>3.10.1</b> BigQuery</a></li>
</ul></li>
<li class="chapter" data-level="3.11" data-path="data-import.html"><a href="data-import.html#copy-data-to-clipboard"><i class="fa fa-check"></i><b>3.11</b> Copy data to clipboard</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tables.html"><a href="tables.html"><i class="fa fa-check"></i><b>4</b> Table/Data Frame manipulation</a><ul>
<li class="chapter" data-level="4.1" data-path="tables.html"><a href="tables.html#pivot-and-reshape-tables"><i class="fa fa-check"></i><b>4.1</b> Pivot and reshape tables</a></li>
<li class="chapter" data-level="4.2" data-path="tables.html"><a href="tables.html#dropping-and-selecting-columns"><i class="fa fa-check"></i><b>4.2</b> Dropping and selecting columns</a></li>
<li class="chapter" data-level="4.3" data-path="tables.html"><a href="tables.html#rename-variables"><i class="fa fa-check"></i><b>4.3</b> Rename variables</a></li>
<li class="chapter" data-level="4.4" data-path="tables.html"><a href="tables.html#filtering-data"><i class="fa fa-check"></i><b>4.4</b> Filtering data</a></li>
<li class="chapter" data-level="4.5" data-path="tables.html"><a href="tables.html#group-data"><i class="fa fa-check"></i><b>4.5</b> Group data</a></li>
<li class="chapter" data-level="4.6" data-path="tables.html"><a href="tables.html#order-data"><i class="fa fa-check"></i><b>4.6</b> Order data</a></li>
<li class="chapter" data-level="4.7" data-path="tables.html"><a href="tables.html#get-counts-of-data"><i class="fa fa-check"></i><b>4.7</b> Get counts of data</a></li>
<li class="chapter" data-level="4.8" data-path="tables.html"><a href="tables.html#combine-tables"><i class="fa fa-check"></i><b>4.8</b> Combine tables</a></li>
<li class="chapter" data-level="4.9" data-path="tables.html"><a href="tables.html#joining-tables"><i class="fa fa-check"></i><b>4.9</b> Joining tables</a></li>
<li class="chapter" data-level="4.10" data-path="tables.html"><a href="tables.html#select-specific-columns-in-a-join"><i class="fa fa-check"></i><b>4.10</b> Select specific columns in a join</a></li>
<li class="chapter" data-level="4.11" data-path="tables.html"><a href="tables.html#sum-rows-or-columns"><i class="fa fa-check"></i><b>4.11</b> Sum rows or columns</a><ul>
<li class="chapter" data-level="4.11.1" data-path="tables.html"><a href="tables.html#sum-rows"><i class="fa fa-check"></i><b>4.11.1</b> Sum rows</a></li>
<li class="chapter" data-level="4.11.2" data-path="tables.html"><a href="tables.html#sum-columns"><i class="fa fa-check"></i><b>4.11.2</b> Sum columns</a></li>
</ul></li>
<li class="chapter" data-level="4.12" data-path="tables.html"><a href="tables.html#replace-nas-or-other-values"><i class="fa fa-check"></i><b>4.12</b> Replace NAs or other values</a></li>
<li class="chapter" data-level="4.13" data-path="tables.html"><a href="tables.html#reordering-rowscolumns"><i class="fa fa-check"></i><b>4.13</b> Reordering rows/columns</a><ul>
<li class="chapter" data-level="4.13.1" data-path="tables.html"><a href="tables.html#reordering-rows"><i class="fa fa-check"></i><b>4.13.1</b> Reordering rows</a></li>
<li class="chapter" data-level="4.13.2" data-path="tables.html"><a href="tables.html#reordering-columns"><i class="fa fa-check"></i><b>4.13.2</b> Reordering columns</a></li>
</ul></li>
<li class="chapter" data-level="4.14" data-path="tables.html"><a href="tables.html#creating-new-variables"><i class="fa fa-check"></i><b>4.14</b> Creating new variables</a></li>
<li class="chapter" data-level="4.15" data-path="tables.html"><a href="tables.html#summarising-data"><i class="fa fa-check"></i><b>4.15</b> Summarising data</a></li>
<li class="chapter" data-level="4.16" data-path="tables.html"><a href="tables.html#look-up-tables"><i class="fa fa-check"></i><b>4.16</b> Look up tables</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="dates-times.html"><a href="dates-times.html"><i class="fa fa-check"></i><b>5</b> Working with dates and times</a><ul>
<li class="chapter" data-level="5.1" data-path="dates-times.html"><a href="dates-times.html#working-with-dates"><i class="fa fa-check"></i><b>5.1</b> Working with dates</a><ul>
<li class="chapter" data-level="5.1.1" data-path="dates-times.html"><a href="dates-times.html#converting-a-character-to-a-date"><i class="fa fa-check"></i><b>5.1.1</b> Converting a character to a date</a></li>
<li class="chapter" data-level="5.1.2" data-path="dates-times.html"><a href="dates-times.html#get-year-from-date"><i class="fa fa-check"></i><b>5.1.2</b> Get year from date</a></li>
<li class="chapter" data-level="5.1.3" data-path="dates-times.html"><a href="dates-times.html#get-month-from-date"><i class="fa fa-check"></i><b>5.1.3</b> Get month from date</a></li>
<li class="chapter" data-level="5.1.4" data-path="dates-times.html"><a href="dates-times.html#get-day-from-date"><i class="fa fa-check"></i><b>5.1.4</b> Get day from date</a></li>
<li class="chapter" data-level="5.1.5" data-path="dates-times.html"><a href="dates-times.html#get-weekday-from-date"><i class="fa fa-check"></i><b>5.1.5</b> Get weekday from date</a></li>
<li class="chapter" data-level="5.1.6" data-path="dates-times.html"><a href="dates-times.html#get-quarter-from-date"><i class="fa fa-check"></i><b>5.1.6</b> Get quarter from date</a></li>
<li class="chapter" data-level="5.1.7" data-path="dates-times.html"><a href="dates-times.html#find-difference-between-two-dates"><i class="fa fa-check"></i><b>5.1.7</b> Find difference between two dates</a></li>
<li class="chapter" data-level="5.1.8" data-path="dates-times.html"><a href="dates-times.html#convert-month-integer-to-character"><i class="fa fa-check"></i><b>5.1.8</b> Convert month (integer to character)</a></li>
<li class="chapter" data-level="5.1.9" data-path="dates-times.html"><a href="dates-times.html#convert-month-character-to-integer"><i class="fa fa-check"></i><b>5.1.9</b> Convert month (character to integer)</a></li>
<li class="chapter" data-level="5.1.10" data-path="dates-times.html"><a href="dates-times.html#merge-separate-date-information-into-a-date"><i class="fa fa-check"></i><b>5.1.10</b> Merge separate date information into a date</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="dates-times.html"><a href="dates-times.html#working-with-date-times"><i class="fa fa-check"></i><b>5.2</b> Working with date-times</a><ul>
<li class="chapter" data-level="5.2.1" data-path="dates-times.html"><a href="dates-times.html#converting-a-character-to-a-date-time"><i class="fa fa-check"></i><b>5.2.1</b> Converting a character to a date-time</a></li>
<li class="chapter" data-level="5.2.2" data-path="dates-times.html"><a href="dates-times.html#extract-date-from-date-time-variable"><i class="fa fa-check"></i><b>5.2.2</b> Extract date from date time variable</a></li>
<li class="chapter" data-level="5.2.3" data-path="dates-times.html"><a href="dates-times.html#convert-character-to-hms-time-variable"><i class="fa fa-check"></i><b>5.2.3</b> Convert character to hms (time) variable</a></li>
<li class="chapter" data-level="5.2.4" data-path="dates-times.html"><a href="dates-times.html#extract-hour-from-time"><i class="fa fa-check"></i><b>5.2.4</b> Extract hour from time</a></li>
<li class="chapter" data-level="5.2.5" data-path="dates-times.html"><a href="dates-times.html#extract-minute-from-time"><i class="fa fa-check"></i><b>5.2.5</b> Extract minute from time</a></li>
<li class="chapter" data-level="5.2.6" data-path="dates-times.html"><a href="dates-times.html#extract-second-from-time"><i class="fa fa-check"></i><b>5.2.6</b> Extract second from time</a></li>
<li class="chapter" data-level="5.2.7" data-path="dates-times.html"><a href="dates-times.html#merge-separate-time-information-into-one-variable"><i class="fa fa-check"></i><b>5.2.7</b> Merge separate time information into one variable</a></li>
<li class="chapter" data-level="5.2.8" data-path="dates-times.html"><a href="dates-times.html#find-the-difference-between-two-times"><i class="fa fa-check"></i><b>5.2.8</b> find the difference between two times</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="factors.html"><a href="factors.html"><i class="fa fa-check"></i><b>6</b> Working with factors</a><ul>
<li class="chapter" data-level="6.1" data-path="factors.html"><a href="factors.html#common-uses"><i class="fa fa-check"></i><b>6.1</b> Common uses</a><ul>
<li class="chapter" data-level="6.1.1" data-path="factors.html"><a href="factors.html#tabulation-of-data"><i class="fa fa-check"></i><b>6.1.1</b> Tabulation of data</a></li>
<li class="chapter" data-level="6.1.2" data-path="factors.html"><a href="factors.html#ordering-of-data-for-output"><i class="fa fa-check"></i><b>6.1.2</b> Ordering of data for output</a></li>
<li class="chapter" data-level="6.1.3" data-path="factors.html"><a href="factors.html#statistical-models"><i class="fa fa-check"></i><b>6.1.3</b> Statistical models</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="factors.html"><a href="factors.html#other-things-to-know-about-factors"><i class="fa fa-check"></i><b>6.2</b> Other things to know about factors</a><ul>
<li class="chapter" data-level="6.2.1" data-path="factors.html"><a href="factors.html#renaming-factor-levels"><i class="fa fa-check"></i><b>6.2.1</b> Renaming factor levels</a></li>
<li class="chapter" data-level="6.2.2" data-path="factors.html"><a href="factors.html#combining-factors-does-not-result-in-a-factor"><i class="fa fa-check"></i><b>6.2.2</b> Combining factors does not result in a factor</a></li>
<li class="chapter" data-level="6.2.3" data-path="factors.html"><a href="factors.html#numeric-vectors-that-have-been-read-as-factors"><i class="fa fa-check"></i><b>6.2.3</b> Numeric vectors that have been read as factors</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="factors.html"><a href="factors.html#helpful-packages"><i class="fa fa-check"></i><b>6.3</b> Helpful packages</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="plots.html"><a href="plots.html"><i class="fa fa-check"></i><b>7</b> Plotting and Data Visualisations</a><ul>
<li class="chapter" data-level="7.1" data-path="plots.html"><a href="plots.html#plotting-in-base-r"><i class="fa fa-check"></i><b>7.1</b> Plotting in base R</a><ul>
<li class="chapter" data-level="7.1.1" data-path="plots.html"><a href="plots.html#line-charts-in-base-r"><i class="fa fa-check"></i><b>7.1.1</b> Line charts in base R</a></li>
<li class="chapter" data-level="7.1.2" data-path="plots.html"><a href="plots.html#bar-charts-in-base-r"><i class="fa fa-check"></i><b>7.1.2</b> Bar charts in base R</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="plots.html"><a href="plots.html#plotting-withh-ggplot2"><i class="fa fa-check"></i><b>7.2</b> Plotting withh {ggplot2}</a><ul>
<li class="chapter" data-level="7.2.1" data-path="plots.html"><a href="plots.html#line-charts-with-ggplot2"><i class="fa fa-check"></i><b>7.2.1</b> Line charts with {ggplot2}</a></li>
<li class="chapter" data-level="7.2.2" data-path="plots.html"><a href="plots.html#aesthetic-mappings"><i class="fa fa-check"></i><b>7.2.2</b> Aesthetic mappings</a></li>
<li class="chapter" data-level="7.2.3" data-path="plots.html"><a href="plots.html#bar-charts-with-ggplot2"><i class="fa fa-check"></i><b>7.2.3</b> Bar charts with {ggplot2}</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="plots.html"><a href="plots.html#dft-colours"><i class="fa fa-check"></i><b>7.3</b> DfT colours</a></li>
<li class="chapter" data-level="7.4" data-path="plots.html"><a href="plots.html#dft-theme"><i class="fa fa-check"></i><b>7.4</b> DfT Theme</a><ul>
<li class="chapter" data-level="7.4.1" data-path="plots.html"><a href="plots.html#custom-dft-theme"><i class="fa fa-check"></i><b>7.4.1</b> Custom DfT Theme</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="plots.html"><a href="plots.html#more-ggplot2-charts"><i class="fa fa-check"></i><b>7.5</b> More {ggplot2} charts</a><ul>
<li class="chapter" data-level="7.5.1" data-path="plots.html"><a href="plots.html#scatter-plots"><i class="fa fa-check"></i><b>7.5.1</b> Scatter plots</a></li>
<li class="chapter" data-level="7.5.2" data-path="plots.html"><a href="plots.html#horizontal-bar-chart"><i class="fa fa-check"></i><b>7.5.2</b> Horizontal bar chart</a></li>
<li class="chapter" data-level="7.5.3" data-path="plots.html"><a href="plots.html#stacked-bar-chart"><i class="fa fa-check"></i><b>7.5.3</b> Stacked bar chart</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="plots.html"><a href="plots.html#interactive-charts-with-plotly"><i class="fa fa-check"></i><b>7.6</b> Interactive charts with {plotly}</a><ul>
<li class="chapter" data-level="7.6.1" data-path="plots.html"><a href="plots.html#plotly-with-ggplot2"><i class="fa fa-check"></i><b>7.6.1</b> {plotly} with {ggplot2}</a></li>
<li class="chapter" data-level="7.6.2" data-path="plots.html"><a href="plots.html#plot_ly"><i class="fa fa-check"></i><b>7.6.2</b> plot_ly()</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="plots.html"><a href="plots.html#mapping-in-r"><i class="fa fa-check"></i><b>7.7</b> Mapping in R</a><ul>
<li class="chapter" data-level="7.7.1" data-path="plots.html"><a href="plots.html#mapping-with-ggplot2"><i class="fa fa-check"></i><b>7.7.1</b> Mapping with {ggplot2}</a></li>
<li class="chapter" data-level="7.7.2" data-path="plots.html"><a href="plots.html#mapping-with-leaflet"><i class="fa fa-check"></i><b>7.7.2</b> Mapping with {leaflet}</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="RAP.html"><a href="RAP.html"><i class="fa fa-check"></i><b>8</b> DfT RAP guidance</a><ul>
<li class="chapter" data-level="8.1" data-path="RAP.html"><a href="RAP.html#what"><i class="fa fa-check"></i><b>8.1</b> What</a></li>
<li class="chapter" data-level="8.2" data-path="RAP.html"><a href="RAP.html#when"><i class="fa fa-check"></i><b>8.2</b> When</a></li>
<li class="chapter" data-level="8.3" data-path="RAP.html"><a href="RAP.html#additional-resources"><i class="fa fa-check"></i><b>8.3</b> Additional resources</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="spatial.html"><a href="spatial.html"><i class="fa fa-check"></i><b>9</b> Spatial Analysis in R</a><ul>
<li class="chapter" data-level="9.1" data-path="spatial.html"><a href="spatial.html#what-is-spatial-data"><i class="fa fa-check"></i><b>9.1</b> What is Spatial Data?</a></li>
<li class="chapter" data-level="9.2" data-path="spatial.html"><a href="spatial.html#packages"><i class="fa fa-check"></i><b>9.2</b> Packages</a></li>
<li class="chapter" data-level="9.3" data-path="spatial.html"><a href="spatial.html#reading-in-spatial-data"><i class="fa fa-check"></i><b>9.3</b> Reading in Spatial Data</a></li>
<li class="chapter" data-level="9.4" data-path="spatial.html"><a href="spatial.html#crs-projections"><i class="fa fa-check"></i><b>9.4</b> CRS Projections</a></li>
<li class="chapter" data-level="9.5" data-path="spatial.html"><a href="spatial.html#manipulating-spatial-data"><i class="fa fa-check"></i><b>9.5</b> Manipulating Spatial Data</a></li>
<li class="chapter" data-level="9.6" data-path="spatial.html"><a href="spatial.html#spatial-analysis---joins"><i class="fa fa-check"></i><b>9.6</b> Spatial Analysis - Joins</a></li>
<li class="chapter" data-level="9.7" data-path="spatial.html"><a href="spatial.html#plotting-and-simplifying"><i class="fa fa-check"></i><b>9.7</b> Plotting and simplifying</a></li>
<li class="chapter" data-level="9.8" data-path="spatial.html"><a href="spatial.html#mapping-spatial-data"><i class="fa fa-check"></i><b>9.8</b> Mapping Spatial Data</a></li>
<li class="chapter" data-level="9.9" data-path="spatial.html"><a href="spatial.html#other-spatial-types"><i class="fa fa-check"></i><b>9.9</b> Other Spatial Types</a></li>
<li class="chapter" data-level="9.10" data-path="spatial.html"><a href="spatial.html#further-resources"><i class="fa fa-check"></i><b>9.10</b> Further Resources</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">DfT R Cookbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial" class="section level1">
<h1><span class="header-section-number">Chapter 9</span> Spatial Analysis in R</h1>
<div id="what-is-spatial-data" class="section level2">
<h2><span class="header-section-number">9.1</span> What is Spatial Data?</h2>
<p>For most work in R we work with flat data, i.e. data that is only 1 or 2 dimensions. A data frame, for example, has two dimensions (rows representing observations and columns representing variables), and no other information outside of that two dimensional array. Spatial data however needs some extra information for it to accurately represent actual locations on the Earth: the coordinates of the object; and a system of reference for how the coordinates relate to a physical location on Earth.</p>
</div>
<div id="packages" class="section level2">
<h2><span class="header-section-number">9.2</span> Packages</h2>
<p>To hold spatial data, we need to leverage packages which exist outside of Base R. We will be using the {sf} package for these example, but note that it is common to see spatial data held in the {sp}, {geojson}, and {raster} packages as well, all of which have their own advantages and disadvantages (it is not uncommon to have to switch from one to another to leverage these advantages - more on that later).</p>
<p>The advantage of using the {sf} package is that data is kept in as similar a format to a flat data frame as possible. This makes it easier to work with our data for two reasons. First, it lets us use {dplyr} data manipulations or join our spatial data with non-spatial data (some spatial data formats don’t let you do this). Second, it’s just simplier to wrap your head around.</p>
</div>
<div id="reading-in-spatial-data" class="section level2">
<h2><span class="header-section-number">9.3</span> Reading in Spatial Data</h2>
<p>Let’s have a look at some data. We can read in our data as a spatial object using the <strong>st_read</strong> funciton from the {sf} package (if it is saved in an .shp format and has necessary metadata). We’ll be working with some shapefiles which represent local authorities which are sourced from the ONS.</p>
<p><em>Reading in Spatial Data</em></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1">LAs &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="st">&quot;data/LAs&quot;</span>)</a>
<a class="sourceLine" id="cb221-2" data-line-number="2"><span class="co">#&gt; Reading layer `LAs&#39; from data source `/home/travis/build/departmentfortransport/R-cookbook/data/LAs&#39; using driver `ESRI Shapefile&#39;</span></a>
<a class="sourceLine" id="cb221-3" data-line-number="3"><span class="co">#&gt; Simple feature collection with 382 features and 2 fields</span></a>
<a class="sourceLine" id="cb221-4" data-line-number="4"><span class="co">#&gt; geometry type:  MULTIPOLYGON</span></a>
<a class="sourceLine" id="cb221-5" data-line-number="5"><span class="co">#&gt; dimension:      XY</span></a>
<a class="sourceLine" id="cb221-6" data-line-number="6"><span class="co">#&gt; bbox:           xmin: 364.2663 ymin: 9909.1 xmax: 655599.6 ymax: 1218502</span></a>
<a class="sourceLine" id="cb221-7" data-line-number="7"><span class="co">#&gt; proj4string:    +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +units=m +no_defs</span></a></code></pre></div>
<p>Looking at the message we get when we load in our data, we can find out some basic information about our sf dataframe:</p>
<ul>
<li>It tells us that it is a “Simple feature collection with 391 features and 10 fields”. In other words, this is telling us that it is an sf dataframe of 391 observations (features) and 10 variables (fields).</li>
<li>The geometry type is “MULTIPOLYGON”. To break this down, the “POLYGON” is telling us we’re dealing with distinct shapes for each observation (as opposed to lines or dots), and the “MULTI” is telling us that one observation can be represented by multiple polygons. An example of this would be the Shetland Islands, a single local authority made up of many small polygons.</li>
<li>The “bbox”&quot; gives us the coordinates of a bounding box which will contain all the features of the sf data frame.</li>
<li>The “epsg” and “proj4string” gives us the coordinate reference system. The most common code you will see is 4326 which refers to the “World Geodetic System 1984”. This is the coordinate reference system you are probably most familiar with (without realising it), as it is used in most GPS and mapping software. Points in the WGS system are referred to by their “latitude” and “longitude”. In this case, the epsg code is “NA”, in which case we will have to refer to the documentation to discern the correct epsg code to apply to the data.</li>
</ul>
<p>We can also ask R to give us all of this info with the <strong>st_geometry</strong> function.</p>
<p><em>Inspect spatial data</em></p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" data-line-number="1">sf<span class="op">::</span><span class="kw">st_geometry</span>(LAs)</a>
<a class="sourceLine" id="cb222-2" data-line-number="2"><span class="co">#&gt; Geometry set for 382 features </span></a>
<a class="sourceLine" id="cb222-3" data-line-number="3"><span class="co">#&gt; geometry type:  MULTIPOLYGON</span></a>
<a class="sourceLine" id="cb222-4" data-line-number="4"><span class="co">#&gt; dimension:      XY</span></a>
<a class="sourceLine" id="cb222-5" data-line-number="5"><span class="co">#&gt; bbox:           xmin: 364.2663 ymin: 9909.1 xmax: 655599.6 ymax: 1218502</span></a>
<a class="sourceLine" id="cb222-6" data-line-number="6"><span class="co">#&gt; proj4string:    +proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +units=m +no_defs </span></a>
<a class="sourceLine" id="cb222-7" data-line-number="7"><span class="co">#&gt; First 5 geometries:</span></a>
<a class="sourceLine" id="cb222-8" data-line-number="8"><span class="co">#&gt; MULTIPOLYGON (((448874 536622.6, 453089.1 53411...</span></a>
<a class="sourceLine" id="cb222-9" data-line-number="9"><span class="co">#&gt; MULTIPOLYGON (((451744.3 520566.4, 451788.8 520...</span></a>
<a class="sourceLine" id="cb222-10" data-line-number="10"><span class="co">#&gt; MULTIPOLYGON (((478094.9 518835.6, 475360.6 516...</span></a>
<a class="sourceLine" id="cb222-11" data-line-number="11"><span class="co">#&gt; MULTIPOLYGON (((448472.8 525830.1, 448796 52591...</span></a>
<a class="sourceLine" id="cb222-12" data-line-number="12"><span class="co">#&gt; MULTIPOLYGON (((515719.3 428570.8, 515724.4 428...</span></a></code></pre></div>
</div>
<div id="crs-projections" class="section level2">
<h2><span class="header-section-number">9.4</span> CRS Projections</h2>
<p><a href="https://www.axismaps.com/guide/general/map-projections/">There’s a lot that can be said</a> about the utlity of different Coordinate Reference Systems, but long-story-short they all have unique advantages and disadvantages as they distort shape, distance, or size in different ways. In our day-to-day work, you’re most likely to encounter two coordinate reference systems: the World Geodatic System (WGS84 - EPSG code: 4326), or the Ordance Survey Great Britain 1936 system (OSGB36 - EPSG code: 27700).</p>
<p>The WGS84 system is best suited to global data - for example plotting international ports or a world map of countries. It is a geodatic system, which means the points it defines refer to a point on a 3d elipsoid which represents the earth.</p>
<p>The OSGB1936 system is best suited to mapping the UK or areas within it. It is a projected system, which means it projects the 3d curve of the earth into a 2d object. An advantage of this is that eastings (the x-axis of this projection) remains consistent at all northings (the y-axis). For example, a 1000 unit change in eastings is a 1km change <em>anywhere</em>, whereas a 1 unit change in longitude is a different distance depending on the latitude, as the earth gets narrower the further away you get from the equator.</p>
<p>Complexities aside, practically what this means is that you will always want <em>all</em> of you’re spatial data to be in the same CRS, otherwise spatial joins and mapping functions will start throwing up errors. We can change the crs projection very easily with the {sf} function <strong>st_transform</strong>.</p>
<p><em>Changing Coordinate Reference System</em></p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" data-line-number="1">LAs &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_transform</span>(LAs, <span class="dt">crs =</span> <span class="dv">27700</span>)</a>
<a class="sourceLine" id="cb223-2" data-line-number="2"></a>
<a class="sourceLine" id="cb223-3" data-line-number="3">sf<span class="op">::</span><span class="kw">st_crs</span>(LAs)</a>
<a class="sourceLine" id="cb223-4" data-line-number="4"><span class="co">#&gt; Coordinate Reference System:</span></a>
<a class="sourceLine" id="cb223-5" data-line-number="5"><span class="co">#&gt;   User input: EPSG:27700 </span></a>
<a class="sourceLine" id="cb223-6" data-line-number="6"><span class="co">#&gt;   wkt:</span></a>
<a class="sourceLine" id="cb223-7" data-line-number="7"><span class="co">#&gt; PROJCS[&quot;OSGB 1936 / British National Grid&quot;,</span></a>
<a class="sourceLine" id="cb223-8" data-line-number="8"><span class="co">#&gt;     GEOGCS[&quot;OSGB 1936&quot;,</span></a>
<a class="sourceLine" id="cb223-9" data-line-number="9"><span class="co">#&gt;         DATUM[&quot;OSGB_1936&quot;,</span></a>
<a class="sourceLine" id="cb223-10" data-line-number="10"><span class="co">#&gt;             SPHEROID[&quot;Airy 1830&quot;,6377563.396,299.3249646,</span></a>
<a class="sourceLine" id="cb223-11" data-line-number="11"><span class="co">#&gt;                 AUTHORITY[&quot;EPSG&quot;,&quot;7001&quot;]],</span></a>
<a class="sourceLine" id="cb223-12" data-line-number="12"><span class="co">#&gt;             TOWGS84[446.448,-125.157,542.06,0.15,0.247,0.842,-20.489],</span></a>
<a class="sourceLine" id="cb223-13" data-line-number="13"><span class="co">#&gt;             AUTHORITY[&quot;EPSG&quot;,&quot;6277&quot;]],</span></a>
<a class="sourceLine" id="cb223-14" data-line-number="14"><span class="co">#&gt;         PRIMEM[&quot;Greenwich&quot;,0,</span></a>
<a class="sourceLine" id="cb223-15" data-line-number="15"><span class="co">#&gt;             AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],</span></a>
<a class="sourceLine" id="cb223-16" data-line-number="16"><span class="co">#&gt;         UNIT[&quot;degree&quot;,0.0174532925199433,</span></a>
<a class="sourceLine" id="cb223-17" data-line-number="17"><span class="co">#&gt;             AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],</span></a>
<a class="sourceLine" id="cb223-18" data-line-number="18"><span class="co">#&gt;         AUTHORITY[&quot;EPSG&quot;,&quot;4277&quot;]],</span></a>
<a class="sourceLine" id="cb223-19" data-line-number="19"><span class="co">#&gt;     PROJECTION[&quot;Transverse_Mercator&quot;],</span></a>
<a class="sourceLine" id="cb223-20" data-line-number="20"><span class="co">#&gt;     PARAMETER[&quot;latitude_of_origin&quot;,49],</span></a>
<a class="sourceLine" id="cb223-21" data-line-number="21"><span class="co">#&gt;     PARAMETER[&quot;central_meridian&quot;,-2],</span></a>
<a class="sourceLine" id="cb223-22" data-line-number="22"><span class="co">#&gt;     PARAMETER[&quot;scale_factor&quot;,0.9996012717],</span></a>
<a class="sourceLine" id="cb223-23" data-line-number="23"><span class="co">#&gt;     PARAMETER[&quot;false_easting&quot;,400000],</span></a>
<a class="sourceLine" id="cb223-24" data-line-number="24"><span class="co">#&gt;     PARAMETER[&quot;false_northing&quot;,-100000],</span></a>
<a class="sourceLine" id="cb223-25" data-line-number="25"><span class="co">#&gt;     UNIT[&quot;metre&quot;,1,</span></a>
<a class="sourceLine" id="cb223-26" data-line-number="26"><span class="co">#&gt;         AUTHORITY[&quot;EPSG&quot;,&quot;9001&quot;]],</span></a>
<a class="sourceLine" id="cb223-27" data-line-number="27"><span class="co">#&gt;     AXIS[&quot;Easting&quot;,EAST],</span></a>
<a class="sourceLine" id="cb223-28" data-line-number="28"><span class="co">#&gt;     AXIS[&quot;Northing&quot;,NORTH],</span></a>
<a class="sourceLine" id="cb223-29" data-line-number="29"><span class="co">#&gt;     AUTHORITY[&quot;EPSG&quot;,&quot;27700&quot;]]</span></a></code></pre></div>
<p>This changes the CRS projection from the WGS84 system to the OSGB1936 system, converting all of the coordinates to the new system. We can use the crs argument to change to any number of different projections.
Note that this only works if the spatial object has data on the coordinate reference system already. If your data is missing <em>all</em> of this information, you will have to set the crs manually (if you know what the CRS projection <em>should be</em>):</p>
<p><em>Setting Coordinate Reference System</em></p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" data-line-number="1">sf<span class="op">::</span><span class="kw">st_crs</span>(sf_object) &lt;-<span class="st"> </span><span class="dv">27700</span></a></code></pre></div>
</div>
<div id="manipulating-spatial-data" class="section level2">
<h2><span class="header-section-number">9.5</span> Manipulating Spatial Data</h2>
<p>As mentiond above, one of the key advantages of working with spatial data in {sf} format is that we can use tidyverse functions to manipulate our data. Let’s show this in action by creating a new variable.</p>
<p>The variable “lad19cd” has a unique code for each local authority. All codes begin with a letter, followed by a numeric series. The letter refers to the country (“E” for England, “W” for Wales, “S” for Scotland, and “N” for Northern Ireland). We can use this to create a new variable called “country” for each feature.</p>
<p><em>Manipulating {sf} data with dplyr</em></p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1">LAs &lt;-<span class="st"> </span>LAs <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">country =</span> dplyr<span class="op">::</span><span class="kw">case_when</span>(stringr<span class="op">::</span><span class="kw">str_detect</span>(lad19cd, <span class="st">&quot;W&quot;</span>) <span class="op">~</span><span class="st"> &quot;Wales&quot;</span>,</a>
<a class="sourceLine" id="cb225-2" data-line-number="2">                             stringr<span class="op">::</span><span class="kw">str_detect</span>(lad19cd, <span class="st">&quot;S&quot;</span>) <span class="op">~</span><span class="st"> &quot;Scotland&quot;</span>,</a>
<a class="sourceLine" id="cb225-3" data-line-number="3">                             stringr<span class="op">::</span><span class="kw">str_detect</span>(lad19cd, <span class="st">&quot;N&quot;</span>) <span class="op">~</span><span class="st"> &quot;Northern Ireland&quot;</span>,</a>
<a class="sourceLine" id="cb225-4" data-line-number="4">                             stringr<span class="op">::</span><span class="kw">str_detect</span>(lad19cd, <span class="st">&quot;E&quot;</span>) <span class="op">~</span><span class="st"> &quot;England&quot;</span>))</a>
<a class="sourceLine" id="cb225-5" data-line-number="5"></a>
<a class="sourceLine" id="cb225-6" data-line-number="6">LAs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(country) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tally</span>()</a></code></pre></div>
<div class="kable-table">

<table>
<thead>
<tr>
<th style="text-align:left;">
country
</th>
<th style="text-align:right;">
n
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
England
</td>
<td style="text-align:right;">
317
</td>
</tr>
<tr>
<td style="text-align:left;">
Northern Ireland
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
Scotland
</td>
<td style="text-align:right;">
32
</td>
</tr>
<tr>
<td style="text-align:left;">
Wales
</td>
<td style="text-align:right;">
22
</td>
</tr>
</tbody>
</table>
</div>
<p>As we can see, we’ve manipulated our data in exactly the same way as we would have with a flat dataframe.We can also join spatial and non-spatial data together in the same way we normally would with dataframes.
Let’s take some population data and join it to our Local Authorities.</p>
<p><em>Joining Spatial and non-spatial data</em></p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" data-line-number="1"><span class="kw">summary</span>(LAs_pop)</a>
<a class="sourceLine" id="cb226-2" data-line-number="2"><span class="co">#&gt;    lad19cd            population      </span></a>
<a class="sourceLine" id="cb226-3" data-line-number="3"><span class="co">#&gt;  Length:437         Min.   :    2242  </span></a>
<a class="sourceLine" id="cb226-4" data-line-number="4"><span class="co">#&gt;  Class :character   1st Qu.:  104503  </span></a>
<a class="sourceLine" id="cb226-5" data-line-number="5"><span class="co">#&gt;  Mode  :character   Median :  147997  </span></a>
<a class="sourceLine" id="cb226-6" data-line-number="6"><span class="co">#&gt;                     Mean   :  960204  </span></a>
<a class="sourceLine" id="cb226-7" data-line-number="7"><span class="co">#&gt;                     3rd Qu.:  276374  </span></a>
<a class="sourceLine" id="cb226-8" data-line-number="8"><span class="co">#&gt;                     Max.   :66435550  </span></a>
<a class="sourceLine" id="cb226-9" data-line-number="9"><span class="co">#&gt;                     NA&#39;s   :7</span></a></code></pre></div>
<p>This dataframe of local authority populations has 2 variables, local authority code (lad19cd) and population. We can use a {dplyr} <strong>left_join</strong> to join this to our {sf} dataframe as we would with a flat dataframe.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb227-1" data-line-number="1">LAs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(LAs, LAs_pop, <span class="dt">by =</span> <span class="st">&quot;lad19cd&quot;</span>)</a>
<a class="sourceLine" id="cb227-2" data-line-number="2"></a>
<a class="sourceLine" id="cb227-3" data-line-number="3">LAs<span class="op">$</span>population &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(LAs<span class="op">$</span>population)</a></code></pre></div>
</div>
<div id="spatial-analysis---joins" class="section level2">
<h2><span class="header-section-number">9.6</span> Spatial Analysis - Joins</h2>
<p>A common task we might want to conduct is to manipulated a spatial object based on a relationship with another spatial object. To do this, we will use the <strong>st_join</strong> function from the {sf} package. The <strong>st_join</strong> allows us to join data on a number of different relationships, the simplest of which examines whether an object intersects another object - i.e. if there is any point where the geometries of both objects are identical. This could be where two lines cross, where two different spatial points objects have the same gemoetry, or it could be a point falling within the bounds of a polygon.</p>
<p>Let’s look at some data representing the coordinates of road traffic accidents in Great Britain.</p>
<p><em>Read in csv</em></p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" data-line-number="1"><span class="kw">class</span>(crash_data)</a>
<a class="sourceLine" id="cb228-2" data-line-number="2"><span class="co">#&gt; [1] &quot;data.frame&quot;</span></a>
<a class="sourceLine" id="cb228-3" data-line-number="3"><span class="kw">names</span>(crash_data)</a>
<a class="sourceLine" id="cb228-4" data-line-number="4"><span class="co">#&gt; [1] &quot;Location_Easting_OSGR&quot;  &quot;Location_Northing_OSGR&quot; &quot;Date&quot;                  </span></a>
<a class="sourceLine" id="cb228-5" data-line-number="5"><span class="co">#&gt; [4] &quot;Number_of_Casualties&quot;</span></a></code></pre></div>
<p>Our crash data is in a flat csv format, BUT it has variables representing the easting and northing of where each acccident took place. We can use this to turn our crash data into an sf object with the function <strong>st_as_sf</strong>. We take our dataset, define which variables R should use to define coordinates in the “coords” argument, and define the “crs” that those coordinates are plotted in.</p>
<p><em>Transforming flat data frames to spatial data</em></p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1">crashes &lt;-<span class="st"> </span>crash_data <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(Location_Easting_OSGR) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(Location_Northing_OSGR)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb229-2" data-line-number="2">sf<span class="op">::</span><span class="kw">st_as_sf</span>(<span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">&quot;Location_Easting_OSGR&quot;</span>,<span class="st">&quot;Location_Northing_OSGR&quot;</span>), <span class="dt">crs =</span> <span class="dv">27700</span>)</a>
<a class="sourceLine" id="cb229-3" data-line-number="3"></a>
<a class="sourceLine" id="cb229-4" data-line-number="4">sf<span class="op">::</span><span class="kw">st_geometry</span>(crashes)</a>
<a class="sourceLine" id="cb229-5" data-line-number="5"><span class="co">#&gt; Geometry set for 122580 features </span></a>
<a class="sourceLine" id="cb229-6" data-line-number="6"><span class="co">#&gt; geometry type:  POINT</span></a>
<a class="sourceLine" id="cb229-7" data-line-number="7"><span class="co">#&gt; dimension:      XY</span></a>
<a class="sourceLine" id="cb229-8" data-line-number="8"><span class="co">#&gt; bbox:           xmin: 84654 ymin: 10235 xmax: 655275 ymax: 1209512</span></a>
<a class="sourceLine" id="cb229-9" data-line-number="9"><span class="co">#&gt; CRS:            EPSG:27700</span></a>
<a class="sourceLine" id="cb229-10" data-line-number="10"><span class="co">#&gt; First 5 geometries:</span></a>
<a class="sourceLine" id="cb229-11" data-line-number="11"><span class="co">#&gt; POINT (529150 182270)</span></a>
<a class="sourceLine" id="cb229-12" data-line-number="12"><span class="co">#&gt; POINT (542020 184290)</span></a>
<a class="sourceLine" id="cb229-13" data-line-number="13"><span class="co">#&gt; POINT (531720 182910)</span></a>
<a class="sourceLine" id="cb229-14" data-line-number="14"><span class="co">#&gt; POINT (541450 183220)</span></a>
<a class="sourceLine" id="cb229-15" data-line-number="15"><span class="co">#&gt; POINT (543580 176500)</span></a></code></pre></div>
<p>The crashes sf dataframe holds information on all reported road traffic accidents in the UK since 2005. It has a number of variables for each accident, such as the accident severity, number of vehicles, number of casualties, time of day, and road and weather conditions.</p>
<p>Let’s have a look at the most severe accidents (accidents with 5 or more casualties).</p>
<p><em>Quick map of spatial data</em></p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1">crashes <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(Number_of_Casualties <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span><span class="st"> </span>tmap<span class="op">::</span><span class="kw">qtm</span>()</a></code></pre></div>
<p><img src="image/crashesq.png" /></p>
<p>The <strong>qtm</strong> function is a useful function from {tmap} that let’s us quickly create maps with a minimum number of arguments. This is often useful for sense-checking data and can help you spot errors in data manipulation when working with spatial data. Here, for example, we can see that our data largely makes sense, so our conversion to {sf} was likely correct. We can (roughly) make out the shape of Great Britain, and we see some clusters around major cities (London, Birmingham, Manchester etc.). We can also see that we don’t appear to have data for Northern Ireland in this dataset (either that or Northern Irish drivers are much safer drivers).</p>
<p>Let’s see can we work out which Local Authority has had the most road traffic casualties in this period.
We can use a <strong>spatial join</strong> to assign a local authority to each road traffic accident. This works similarly to a {dplyr} left_join, with all of the variables from the <strong>y</strong> table being added to each observation of the <strong>x</strong> table which match eachother by a defined variable. The difference here is that the two tables are joined based on a shared <strong>geometry</strong>, rather than a shared value of a variable. The shared geometry here being whether a point intersects with a polygon (in other words, whether the point falls within a polygon).</p>
<p><em>Joining spatial data</em></p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1">crashes_join &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_join</span>(crashes, LAs, <span class="dt">join =</span> st_intersects) <span class="co"># essentially a left_join of LAs to crashes</span></a>
<a class="sourceLine" id="cb231-2" data-line-number="2">crashes_join<span class="op">$</span>LA_name &lt;-<span class="st"> </span><span class="kw">as.character</span>(crashes_join<span class="op">$</span>LA_name)</a>
<a class="sourceLine" id="cb231-3" data-line-number="3"></a>
<a class="sourceLine" id="cb231-4" data-line-number="4">LAs_casualties &lt;-<span class="st"> </span>crashes_join <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(LA_name) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(<span class="dt">casualties =</span> <span class="kw">sum</span>(Number_of_Casualties)) <span class="co"># making an sf data frame called LAs_casualties which is the result of a simple group_by and summarise.</span></a>
<a class="sourceLine" id="cb231-5" data-line-number="5"></a>
<a class="sourceLine" id="cb231-6" data-line-number="6">LAs_casualties <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">arrange</span>(<span class="kw">desc</span>(casualties)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(LA_name, casualties) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</a></code></pre></div>
<div class="kable-table">

<table>
<thead>
<tr>
<th style="text-align:left;">
LA_name
</th>
<th style="text-align:right;">
casualties
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Birmingham
</td>
<td style="text-align:right;">
3592
</td>
</tr>
<tr>
<td style="text-align:left;">
Leeds
</td>
<td style="text-align:right;">
1980
</td>
</tr>
<tr>
<td style="text-align:left;">
Westminster
</td>
<td style="text-align:right;">
1883
</td>
</tr>
<tr>
<td style="text-align:left;">
Cornwall
</td>
<td style="text-align:right;">
1663
</td>
</tr>
<tr>
<td style="text-align:left;">
Lambeth
</td>
<td style="text-align:right;">
1402
</td>
</tr>
<tr>
<td style="text-align:left;">
NA
</td>
<td style="text-align:right;">
1340
</td>
</tr>
</tbody>
</table>
</div>
<p>We can see that Birmingham has had more casualties in this period than any other local authority.</p>
<p>The <em>LAs_casualties</em> dataset that we created above has the same local authorities names as our original <em>LAs</em> sf dataframe, meaning we can easily left_join this table to our original LAs_shapefile. But first, we will turn it into a flat dataframe (ie, with no geographic information) with the <strong>st_set_geometry</strong> function. If we did not get rid of the geometry before left_joining, we would create a “geometry_collection” object for each local authority, which would be a mess of polygons and points within those polygons for each feature. This is because our <strong>group_by</strong> function above also grouped together the geometries of the observations it was grouping together. If we look at the outout above, we can see that the geometry type of LAs_casualties is “MULTIPOINT”, so the “Birmingham” observation has 3,532 points representing where each road accident happened, rather than outlining the polygon of Birmingham in any meaningful way.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" data-line-number="1">LAs_casualties &lt;-<span class="st"> </span>LAs_casualties <span class="op">%&gt;%</span><span class="st"> </span>sf<span class="op">::</span><span class="kw">st_set_geometry</span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb232-2" data-line-number="2"></a>
<a class="sourceLine" id="cb232-3" data-line-number="3">LAs &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">left_join</span>(LAs, LAs_casualties, <span class="dt">by =</span> <span class="st">&quot;LA_name&quot;</span>)</a></code></pre></div>
<p>We now have our casualties data joined to our original local authorities shapefile. We can now use this to make graphical representations of our data.</p>
</div>
<div id="plotting-and-simplifying" class="section level2">
<h2><span class="header-section-number">9.7</span> Plotting and simplifying</h2>
<p>Let’s have a look at one of our Local Authorities in isolation, Cornwall.</p>
<p><img src="image/Cornwall1.png" /></p>
<p>We can see that our polygon is quite detailed. While this detail is desirable for when we conduct our spatial analysis, if we want to plot all of our local authorities at the same time, it can be better to plot simplified polygons. This is for 3 reasons. First, simplification means that R can create and output plots quicker; Second, outputs will have a smaller file size (particularly useful for interactive plots or when we share our outputs); and third, sometimes simplified polygons actually look better in plots as too-detailed borders can come out looking murky due to over-plotting, particularly in static plots.</p>
<p>To alleviate this, we can simplify our geometry features before plotting. For this, we will use the function <strong>ms_simplify</strong> from the package {rmapshaper}. This function simplifies spatial data while maintaining key topology. Simplifying functions in other packages can do funny things such leave gaps between polygons with internal borders when simplifying. <strong>ms_simplify</strong> doesn’t do this.</p>
<p><em>Simplifying Spatial Data</em></p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb233-1" data-line-number="1">LAs_simp &lt;-<span class="st"> </span>rmapshaper<span class="op">::</span><span class="kw">ms_simplify</span>(LAs, <span class="dt">keep =</span> <span class="fl">0.05</span>, <span class="dt">keep_shapes =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p>This command creates a new sf data frame called “LAs_simp”, which has all the same information as the original LAs sf dataframe, but has a simplified geometry with fewer points. The “keep” argument specifies how much geographic information we want to hold onto. Here we only keep 5% of the original points. The “keep_shapes” argument specifies whether or not we want to allow the function to delete some features entirely for simplification purposes. This can be useful for polygons with lots of small islands as individual entries (where you are indifferent to whether or not you keep all islands in your dataset), BUT use with caution, as if you simplify too much R might delete entire features (observations) to fulfill the simplification. Here we set “keep_shapes = TRUE”&quot; so we don’t lose any features.</p>
<p>Let’s have a look at the difference between our original and our simplified polygon:</p>
<p><img src="image/CornwallCompare.png" /></p>
<p>Even with only 5% of the original points, we can see that we’ve held onto a lot of the information that we’d want if we were plotting these polygons.</p>
<p>However, we should always use simplification with caution, and only simplify our spatial objects <em>after</em> we’ve carried out spatial analysis. Note that we can also simplify spatial data which are lines, reducing the number of vertices in lines, but we cannot simplify spatial points data, as their geometries (a single point for each entry) is already as small as it can be.</p>
</div>
<div id="mapping-spatial-data" class="section level2">
<h2><span class="header-section-number">9.8</span> Mapping Spatial Data</h2>
<p>There are a number of packages that you can use to make maps with spatial data in R, including {leaflet}, {ggmap}, {mapdeck}, and {ggplot2}. Here, we will be using the package {tmap}. {tmap} is a highly versatile package for mapping spatial data, with a number of advantages over other packages:</p>
<ul>
<li>{tmap} uses a similar grammar to {ggplot2}, where aesthetic layers are layered on top of each other;</li>
<li>the same piece of {tmap} code can be used to make either static or interactive maps, and;</li>
<li>{tmap} can work with spatial data in a number of different formats, including {sp}, {raster}, {geojson} and {sf}.</li>
</ul>
<p>Similar to using {ggplot2}, the first layer of a tmap defines the spatial object that we wish to plot in the function <strong>tm_shape</strong>. We then add (+) an aesthetic element based on this spatial object Most often this aesthetic element will be one of type <strong>tm_polygons</strong>, <strong>tm_line</strong>, or <strong>tm_dots</strong>, depending on the spatial data type.</p>
<p>Let’s see this in action, and map our local authorities based on how many road traffic casualties there were in each.</p>
<p><em>Create static map in tmap</em></p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb234-1" data-line-number="1">LAs &lt;-<span class="st"> </span>rmapshaper<span class="op">::</span><span class="kw">ms_simplify</span>(LAs, <span class="dt">keep =</span> <span class="fl">0.05</span>, <span class="dt">keep_shapes =</span> <span class="ot">TRUE</span>) <span class="co"># Simplifying polygons. Remember to only do this after you&#39;ve finished your spatial analysis, or to save the simplified version as a different name.</span></a>
<a class="sourceLine" id="cb234-2" data-line-number="2"></a>
<a class="sourceLine" id="cb234-3" data-line-number="3">tmap<span class="op">::</span><span class="kw">tm_shape</span>(LAs) <span class="op">+</span><span class="st"> </span><span class="co"># defining what shapefile to use</span></a>
<a class="sourceLine" id="cb234-4" data-line-number="4"><span class="st">  </span>tmap<span class="op">::</span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;casualties&quot;</span>, <span class="co"># setting the variable to map the colour aesthetic to. tmap takes variable names in quotation marks</span></a>
<a class="sourceLine" id="cb234-5" data-line-number="5">              <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>, <span class="co"># the style option lets us define how we want the variable split</span></a>
<a class="sourceLine" id="cb234-6" data-line-number="6">             <span class="dt">n =</span> <span class="dv">5</span>, <span class="co"># number of quantiles</span></a>
<a class="sourceLine" id="cb234-7" data-line-number="7">              <span class="dt">pal =</span> <span class="st">&quot;YlGnBu&quot;</span> <span class="co"># choose from a number of palettes available from rcolorbrewer, or define your own</span></a>
<a class="sourceLine" id="cb234-8" data-line-number="8">              ) <span class="op">+</span></a>
<a class="sourceLine" id="cb234-9" data-line-number="9"><span class="st">  </span>tmap<span class="op">::</span><span class="kw">tm_borders</span>(<span class="dt">col =</span> <span class="st">&quot;#000000&quot;</span>, <span class="co"># defining polygon border as black</span></a>
<a class="sourceLine" id="cb234-10" data-line-number="10">           <span class="dt">lwd =</span> <span class="fl">0.3</span> <span class="co"># setting border width</span></a>
<a class="sourceLine" id="cb234-11" data-line-number="11">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb234-12" data-line-number="12"><span class="st">  </span>tmap<span class="op">::</span><span class="kw">tm_layout</span>(<span class="dt">legend.outside =</span> <span class="ot">TRUE</span> <span class="co"># putting the legend outside the plot rather than inside</span></a>
<a class="sourceLine" id="cb234-13" data-line-number="13">            )</a></code></pre></div>
<p><img src="image/static1.png" /></p>
<p>One problem with this plot is that we still have Northern Ireland in the plot, and we only have NAs for northern Ireland (as our casualties dataset didn’t have accidents which happened there). To fix this, we can utilise a simple {dplyr} filter to remove features which have an <em>NA</em> value for casualties. We can then pipe a filtered sf dataframe into the <strong>tm_shape</strong> function.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb235-1" data-line-number="1">LAs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-2" data-line-number="2"><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(casualties)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb235-3" data-line-number="3"><span class="kw">tm_shape</span>() <span class="op">+</span><span class="st"> </span><span class="co"># defining what shapefile to use</span></a>
<a class="sourceLine" id="cb235-4" data-line-number="4"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;casualties&quot;</span>, <span class="co"># setting the variable to map the colour aesthetic to. tmap takes variable names in quotation marks</span></a>
<a class="sourceLine" id="cb235-5" data-line-number="5">              <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>, <span class="co"># the style option lets us define how we want the variable split</span></a>
<a class="sourceLine" id="cb235-6" data-line-number="6">              <span class="dt">n =</span> <span class="dv">5</span>, <span class="co"># number of quantiles</span></a>
<a class="sourceLine" id="cb235-7" data-line-number="7">              <span class="dt">pal =</span> <span class="st">&quot;YlGnBu&quot;</span> <span class="co"># choose from a number of palettes available from rcolorbrewer, or define your own</span></a>
<a class="sourceLine" id="cb235-8" data-line-number="8">             ) <span class="op">+</span></a>
<a class="sourceLine" id="cb235-9" data-line-number="9"><span class="st">  </span><span class="kw">tm_borders</span>(<span class="dt">col =</span> <span class="st">&quot;#000000&quot;</span>, <span class="co"># defining polygon border as black</span></a>
<a class="sourceLine" id="cb235-10" data-line-number="10">           <span class="dt">lwd =</span> <span class="fl">0.3</span> <span class="co"># setting border width</span></a>
<a class="sourceLine" id="cb235-11" data-line-number="11">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb235-12" data-line-number="12"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.outside =</span> <span class="ot">TRUE</span> <span class="co"># putting the legend outside the plot rather than inside</span></a>
<a class="sourceLine" id="cb235-13" data-line-number="13">           )</a></code></pre></div>
<p><img src="image/static2.png" /></p>
<p>Though this plot is useful, and gives us a sense of the distribution of accidents, it’s difficult to make out values of smaller local authorities. What would make this easier is if we changed our map to an interactive map. We can do this very easily, using the same chunk of code, by simply setting the <strong>tmap_mode</strong> to “view”.</p>
<p><em>Create interactive map in tmap</em></p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb236-1" data-line-number="1"><span class="kw">tmap_mode</span>(<span class="st">&quot;view&quot;</span>)</a>
<a class="sourceLine" id="cb236-2" data-line-number="2"></a>
<a class="sourceLine" id="cb236-3" data-line-number="3">LAs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-4" data-line-number="4"><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(casualties)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-5" data-line-number="5"><span class="kw">tm_shape</span>() <span class="op">+</span><span class="st"> </span><span class="co"># defining what shapefile to use</span></a>
<a class="sourceLine" id="cb236-6" data-line-number="6"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;casualties&quot;</span>, <span class="co"># setting the variable to map the colour aesthetic to. tmap takes variable names in quotation marks.</span></a>
<a class="sourceLine" id="cb236-7" data-line-number="7">              <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>, <span class="co"># the style option lets us define how we want the variable split</span></a>
<a class="sourceLine" id="cb236-8" data-line-number="8">              <span class="dt">n =</span> <span class="dv">5</span>, <span class="co"># number of quantiles</span></a>
<a class="sourceLine" id="cb236-9" data-line-number="9">             <span class="dt">pal =</span> <span class="st">&quot;YlGnBu&quot;</span> <span class="co"># choose from a number of palettes available from rcolorbrewer, or define your own</span></a>
<a class="sourceLine" id="cb236-10" data-line-number="10">              ) <span class="op">+</span></a>
<a class="sourceLine" id="cb236-11" data-line-number="11"><span class="st"> </span>LAs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-12" data-line-number="12"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(casualties)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb236-13" data-line-number="13"><span class="kw">tm_shape</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb236-14" data-line-number="14"><span class="st">  </span><span class="kw">tm_borders</span>(<span class="dt">col =</span> <span class="st">&quot;#000000&quot;</span>, <span class="co"># defining polygon border as black</span></a>
<a class="sourceLine" id="cb236-15" data-line-number="15">            <span class="dt">lwd =</span> <span class="fl">0.3</span> <span class="co"># setting border width</span></a>
<a class="sourceLine" id="cb236-16" data-line-number="16">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb236-17" data-line-number="17"><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.outside =</span> <span class="ot">TRUE</span> <span class="co"># putting the legend outside the plot rather than inside</span></a>
<a class="sourceLine" id="cb236-18" data-line-number="18">            )</a></code></pre></div>
<iframe src="image/interactive1.html" width="672" height="400px">
</iframe>
<p>It’s worth noting that some arguments in {tmap} are only availble in static plots, and some only available in interactive maps. However, R will just skip the arguments that don’t apply, so it wont break your code to leave them in. Here, the “legend.outside” argument is meaningless in an interactive plot, so is skipped by R when creating this interactive plot.</p>
<p>A problem with this interact plot is that when you click on a local authority, you can’t find out it’s name. The default popup variable is the object id, because it’s the first variable in the sf dataframe, which isn’t very useful. We can manually set the popup variables instead.</p>
<p>We can also make the map look a bit nicer by increasing the transparency of the polygons with the “alpha” argument.</p>
<p>Finally we can pick from any number of basemaps. {tmap} leverages the {leaflet} package for basemaps, and you can find a list of available basemaps <a href="https://leaflet-extras.github.io/leaflet-providers/preview/">here</a>.</p>
<p><em>Improving Interactive Map</em></p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb237-1" data-line-number="1"></a>
<a class="sourceLine" id="cb237-2" data-line-number="2"><span class="kw">tm_basemap</span>(<span class="dt">server =</span> <span class="st">&quot;CartoDB.Positron&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co"># defining basemap</span></a>
<a class="sourceLine" id="cb237-3" data-line-number="3">LAs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(casualties)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb237-5" data-line-number="5"><span class="kw">tm_shape</span>() <span class="op">+</span><span class="st"> </span><span class="co"># defining what shapefile to use</span></a>
<a class="sourceLine" id="cb237-6" data-line-number="6"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;casualties&quot;</span>, <span class="co"># setting the variable to map the colour aesthetic to. tmap takes variable names in quotation marks.</span></a>
<a class="sourceLine" id="cb237-7" data-line-number="7">              <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>, <span class="co"># the style option lets us define how we want the variable split</span></a>
<a class="sourceLine" id="cb237-8" data-line-number="8">              <span class="dt">n =</span> <span class="dv">5</span>, <span class="co"># number of quantiles</span></a>
<a class="sourceLine" id="cb237-9" data-line-number="9">              <span class="dt">pal =</span> <span class="st">&quot;YlGnBu&quot;</span>, <span class="co"># choose from a number of palettes available from rcolorbrewer, or define your own</span></a>
<a class="sourceLine" id="cb237-10" data-line-number="10">              <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="co"># setting transparency</span></a>
<a class="sourceLine" id="cb237-11" data-line-number="11">             <span class="dt">popup.vars =</span> <span class="kw">c</span>(<span class="st">&quot;Local Authority&quot;</span> =<span class="st"> &quot;lad19nm&quot;</span>, <span class="st">&quot;casualties&quot;</span>), <span class="co"># setting variables to be seen on click</span></a>
<a class="sourceLine" id="cb237-12" data-line-number="12">              <span class="dt">id =</span> <span class="st">&quot;lad19nm&quot;</span> <span class="co"># Setting a variable to display when hovered over</span></a>
<a class="sourceLine" id="cb237-13" data-line-number="13">              ) </a></code></pre></div>
<iframe src="image/interactive2.html" width="672" height="400px">
</iframe>
<p>There are myriad aesthetic possibilities in {tmap} and related packages. It’s not uncommon for a map to be built first in {tmap}, before exported as {leaflet} map and further edited in the {leaflet} package, though we wont cover that here. It’s also possible to plot more than one spatial object at the same time. For example, layering polygons, points and lines from various shapefiles. Simply define the new spatial object with <strong>tm_shape</strong> and add aesthetics as before.</p>
<p>Let’s see this in action, adding a layer to our map with the worst car accidents in our dataset (accidents with over 10 casualties).</p>
<p><em>Mapping multiple spatial objects</em></p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb238-1" data-line-number="1"><span class="kw">tm_basemap</span>(<span class="dt">server =</span> <span class="st">&quot;CartoDB.Positron&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="co"># defining basemap</span></a>
<a class="sourceLine" id="cb238-2" data-line-number="2">LAs <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb238-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(casualties)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb238-4" data-line-number="4"><span class="kw">tm_shape</span>() <span class="op">+</span><span class="st"> </span><span class="co"># defining what shapefile to use</span></a>
<a class="sourceLine" id="cb238-5" data-line-number="5"><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">col =</span> <span class="st">&quot;casualties&quot;</span>, <span class="co"># setting the variable to map the colour aesthetic to. tmap takes variable names in quotation marks.</span></a>
<a class="sourceLine" id="cb238-6" data-line-number="6">              <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>, <span class="co"># the style option lets us define how we want the variable split</span></a>
<a class="sourceLine" id="cb238-7" data-line-number="7">              <span class="dt">n =</span> <span class="dv">5</span>, <span class="co"># number of quantiles</span></a>
<a class="sourceLine" id="cb238-8" data-line-number="8">              <span class="dt">pal =</span> <span class="st">&quot;YlGnBu&quot;</span>, <span class="co"># choose from a number of palettes available from rcolorbrewer, or define your own</span></a>
<a class="sourceLine" id="cb238-9" data-line-number="9">              <span class="dt">alpha =</span> <span class="fl">0.4</span>, <span class="co"># setting transparency</span></a>
<a class="sourceLine" id="cb238-10" data-line-number="10">              <span class="dt">popup.vars =</span> <span class="kw">c</span>(<span class="st">&quot;Local Authority&quot;</span> =<span class="st"> &quot;lad19nm&quot;</span>, <span class="st">&quot;casualties&quot;</span>),</a>
<a class="sourceLine" id="cb238-11" data-line-number="11">              <span class="dt">id =</span> <span class="st">&quot;lad19nm&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb238-12" data-line-number="12">crashes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Number_of_Casualties <span class="op">==</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb238-13" data-line-number="13"><span class="kw">tm_shape</span>() <span class="op">+</span><span class="st"> </span><span class="co"># defining our second shapefile to use and plot in the same output as above</span></a>
<a class="sourceLine" id="cb238-14" data-line-number="14"><span class="st">  </span><span class="kw">tm_dots</span>(<span class="dt">col =</span> <span class="st">&quot;red&quot;</span>, <span class="co"># calling tm_dots on point objects</span></a>
<a class="sourceLine" id="cb238-15" data-line-number="15">          <span class="dt">alpha =</span> <span class="fl">0.7</span>, <span class="co"># making the dots partially transparent</span></a>
<a class="sourceLine" id="cb238-16" data-line-number="16">          <span class="dt">jitter =</span> <span class="fl">0.05</span>,  <span class="co"># adding a small amount of random jittering to points so overlayed points are visible</span></a>
<a class="sourceLine" id="cb238-17" data-line-number="17">          <span class="dt">id =</span> <span class="st">&quot;Number_of_Casualties&quot;</span></a>
<a class="sourceLine" id="cb238-18" data-line-number="18">  ) </a></code></pre></div>
<iframe src="image/interactive3.html" width="672" height="400px">
</iframe>
</div>
<div id="other-spatial-types" class="section level2">
<h2><span class="header-section-number">9.9</span> Other Spatial Types</h2>
<p>We have worked only with the {sf} package here, but it’s important to be aware of different types of spatial data formats that exist in R.</p>
<p>Most similar to the {sf} package is {sp}. sp objects hold the different spatial and non-spatial components of a dataset in different “slots”, creating a hierarchical data structure, where an observation in one slot is linked to an observation in another slot. This works similarly to a relational database in SQL. For example, if our local authorities were in sp format, we would access names of local authorities by calling something like “<a href="mailto:LAs_sp@data$lad19nm">LAs_sp@data$lad19nm</a>”. The “@” symbol specifies we want the dataframe “slot”, and then we call the variable with the “$” as usual. Other slots in an sp object are the bounding box, the proj4string (a way of defining the projection, essentially a long-form crs), and the spatial data (points, polygons etc.). A drawback of holding data like this is that you have to use base R to manipulate data. {dplyr} will not work with sp objects, making sp objects more cumbersome to work with.</p>
<p>{sf} was developed to replace {sp}, but as {sf} is a relatively new package, there may be times when you encounter a function you need that only works on an {sp} object. When this happens, we can quickly convert objects back and forth between <em>sf</em> and <em>sp</em> with the following commands:</p>
<p><em>Converting data from sf to sp objects</em></p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb239-1" data-line-number="1">object_sp &lt;-<span class="st"> </span><span class="kw">as</span>(object_sf, <span class="dt">class =</span> <span class="st">&quot;SPATIAL&quot;</span>) <span class="co"># sf to sp object</span></a>
<a class="sourceLine" id="cb239-2" data-line-number="2">object_sf &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(object_sp) <span class="co"># sp to sf object</span></a></code></pre></div>
<p>Another type of spatial data package to be aware of is the {raster} package. Raster objects are in a gridded data format: they define a rectangle, with a point of origin and an end point, and then define the number of rows and columns to split that rectangle into, making a grid of equal cell sizes. This format spares R from having to plot a polygon for every single grid square. It’s often used for altitude or temperature data, but can be used for a wide range of data (eg emissions, or calculating distance from features of interest across a defined spatial area). Raster objects are held in the {raster} package, though plotting can be done with {tmap}, {leaflet}, and a range of mapping packages.</p>
</div>
<div id="further-resources" class="section level2">
<h2><span class="header-section-number">9.10</span> Further Resources</h2>
<p>For a range of shapefiles, the <a href="http://geoportal.statistics.gov.uk/">ONS data portal</a> is a good place to look. It has local authorities with joinable data on average wages, populations, etc. as well as a number of other shapefiles for points/areas of interest such as national parks, hospitals, output areas of different sizes, and rural/urban areas.</p>
<p>For resources on using tmap and other mapping functions, see <a href="http://www.seascapemodels.org/data/data-wrangling-spatial-course.html">this online workshop</a> which covers a range of topics. It should take about 4 hours to do everything in the workshop (but also good to just find individual bits of code). It mostly uses {ggplot2} but it finishes with some work with {raster} and {tmap}.</p>
<p>There’s also <a href="https://www.jessesadler.com/post/gis-with-r-intro/">this very good blog post</a>, which does a good job of peaking under the hood of how sf and sp objects work without getting <em>too</em> technical.</p>
<p>For a more detailed overview of mapping in R, see <a href="https://geocompr.robinlovelace.net/">this amazing online book</a> from Robin Lovelace. Of particular interest are Chapters 5 and 8, but the whole book is useful.</p>

</div>
</div>









            </section>

          </div>
        </div>
      </div>
<a href="RAP.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
